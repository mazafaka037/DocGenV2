name: Build macOS .app

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        python-version: [3.11]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install system deps (brew)
        run: |
          # обычно на runner'е Tk/Tcl уже есть; оставлю комментарии на случай
          which brew || /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" || true
          brew --version || true

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pyinstaller==5.13.0

      - name: Run tests (optional)
        run: |
          # Добавьте сюда тесты, если есть
          echo "No tests configured"

      - name: Build .app with PyInstaller
        env:
          PYTHONWARNINGS: ignore
        run: |
          rm -rf build dist
          # Укажите имя приложения ниже ("DocGen" -> создаст DocGen.app)
          APP_NAME="DocGen"
          # Включаем docx-шаблоны/прочие файлы рядом с .py — перечислите ресурсы, которые используются в рантайме
          # Формат --add-data "src:dest" (macOS / linux style). Если файлы лежат в корне репо — укажите их:
          pyinstaller \
            --noconfirm \
            --windowed \
            --name "${APP_NAME}" \
            --add-data "template_permit.docx:." \
            --add-data "template_spisok.docx:." \
            --add-data "template_order.docx:." \
            --add-data "template_pb_order.docx:." \
            docgen_v2.py

      - name: Prepare artifact (.zip)
        run: |
          set -e
          APP_NAME="DocGen"
          mkdir -p out
          if [ -d "dist/${APP_NAME}.app" ]; then
            # Use ditto to make a zip preserving mac resource forks
            ditto -c -k --sequesterRsrc --keepParent "dist/${APP_NAME}.app" "out/${APP_NAME}-macos.zip"
            ls -l out
          else
            echo "ERROR: expected dist/${APP_NAME}.app but it was not produced"
            ls -la dist || true
            exit 1
          fi

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: DocGen-macos
          path: out/*.zip
